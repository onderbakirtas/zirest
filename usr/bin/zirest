#!/usr/bin/gjs -m
import q from"gi://Adw";import C from"gi://GLib";import e from"gi://Gtk?version=4.0";import K from"gi://Pango";import U from"gi://GtkSource?version=5";import Z from"gi://Gdk?version=4.0";import J from"gi://Soup?version=3.0";import G from"gi://Gio";function oe(l={}){const _=new e.Box({orientation:e.Orientation.HORIZONTAL,hexpand:!0,halign:e.Align.FILL,spacing:2,css_classes:["linked"]}),T=["GET","POST","PUT","PATCH","DELETE"];let L=T[0];const r=new e.Label({label:L}),d=new e.MenuButton({child:r}),h=new e.Popover;d.set_popover(h);const b=new e.ListBox;b.selection_mode=e.SelectionMode.NONE;for(const a of T){const u=new e.ListBoxRow;u.selectable=!1,u.activatable=!1;const v=new e.Button({label:a,css_classes:["flat"]});v.halign=e.Align.FILL,v.hexpand=!0,v.connect("clicked",()=>{L=a,r.label=a,h.popdown()}),u.set_child(v),b.append(u)}h.set_child(b);const y=new e.Entry({hexpand:!0,buffer:new e.EntryBuffer({text:"https://jsonplaceholder.typicode.com/posts"})}),B=new e.Button({label:"Send",css_classes:["suggested-action"]}),m=()=>String(L??"GET"),R=()=>{const a=y;return a.get_text?a.get_text():a.text},i=a=>{const u=y;typeof u.set_text=="function"?u.set_text(a):u.text=a},w=a=>{const u=String(a??"GET").toUpperCase();T.includes(u)&&(L=u,r.label=u)},k=()=>{const a=R();l.onSend?.(m(),String(a??""))};return B.connect("clicked",k),y.connect("activate",k),_.append(d),_.append(y),_.append(B),{widget:_,setRequest:(a,u)=>{w(a),i(u);try{y.grab_focus?.()}catch{}},getRequest:()=>({method:m(),url:String(R()??"")}),setUrl:a=>i(String(a??""))}}const se=l=>C.markup_escape_text(l,-1);function re(){const l=new e.Box({orientation:e.Orientation.VERTICAL,spacing:0,hexpand:!0,vexpand:!0}),T=U.LanguageManager.get_default().get_language("json"),L=U.StyleSchemeManager.get_default(),r=o=>{for(const E of o)try{const n=L.get_scheme(E);if(n)return n}catch{}return null},d=new U.Buffer;try{d.highlight_matching_brackets=!0}catch{}const h=q.StyleManager.get_default(),b=()=>{try{const o=!!h.dark,E=r(o?["Adwaita-dark","adwaita-dark","oblivion","cobalt","kate"]:["Adwaita","adwaita","classic","tango"]);d.style_scheme=E}catch{}};b();try{h.connect("notify::dark",b)}catch{}const y=new U.View({buffer:d,editable:!1,monospace:!0,wrap_mode:e.WrapMode.WORD_CHAR,hexpand:!0,vexpand:!0,left_margin:12,right_margin:12,top_margin:12,bottom_margin:12});try{y.show_line_numbers=!0,y.tab_width=2,y.indent_width=2,y.insert_spaces_instead_of_tabs=!0}catch{}const B=new e.ScrolledWindow({hexpand:!0,vexpand:!0});B.set_policy(e.PolicyType.NEVER,e.PolicyType.AUTOMATIC),B.set_child(y);const m=new e.ListBox({css_classes:["boxed-list"]});m.selection_mode=e.SelectionMode.NONE;const R=new e.ScrolledWindow({hexpand:!0,vexpand:!0});R.set_policy(e.PolicyType.NEVER,e.PolicyType.AUTOMATIC),R.set_child(m);const i=new e.Notebook({hexpand:!0,vexpand:!0});try{i.show_border=!1}catch{}const w=new e.Label({label:"Body"}),k=new e.Label({label:"Headers"});i.append_page(B,w),i.append_page(R,k);const a=o=>{try{i.set_current_page(o)}catch{i.page=o}};a(0);const u=new e.Box({orientation:e.Orientation.HORIZONTAL,spacing:10,halign:e.Align.END,margin_top:6,margin_bottom:6,margin_start:8,margin_end:8}),v=new e.Label({xalign:0,use_markup:!0,label:""}),P=new e.Label({xalign:0,label:""});P.css_classes=["dim-label"];const O=new e.Label({xalign:0,label:""});O.css_classes=["dim-label"],u.append(v),u.append(P),u.append(O);const V=new e.Box({orientation:e.Orientation.HORIZONTAL,hexpand:!0,halign:e.Align.FILL,css_classes:["toolbar"]});V.append(new e.Box({hexpand:!0})),V.append(u),l.append(i),l.append(V);const j=(o,E={})=>{d.set_text(String(o??""),-1);try{E.isJson?(d.language=T,d.highlight_syntax=!0):(d.language=null,d.highlight_syntax=!1)}catch{}};return{widget:l,setText:o=>{j(o,{isJson:!1}),a(0)},setJson:o=>{try{j(JSON.stringify(o,null,2),{isJson:!0})}catch{j(String(o),{isJson:!1})}a(0)},setError:o=>{j(o,{isJson:!1}),a(0)},setHeaders:o=>{for(;;){const n=m.get_first_child();if(!n)break;m.remove(n)}const E=Object.keys(o).sort((n,p)=>n.localeCompare(p));for(const n of E){const p=new e.ListBoxRow;p.selectable=!1,p.activatable=!1;const t=new e.Box({orientation:e.Orientation.VERTICAL,spacing:6,margin_top:10,margin_bottom:10,margin_start:12,margin_end:12}),s=new e.Label({label:n,xalign:0});s.css_classes=["dim-label"];const c=new e.Label({label:String(o[n]??""),xalign:0,wrap:!0,wrap_mode:K.WrapMode.WORD_CHAR,selectable:!0});t.append(s),t.append(c),p.set_child(t),m.append(p)}},setMeta:o=>{const E=String(o.status),n=typeof o.status=="number"?o.status:Number(o.status);let p="#D4D4D4";Number.isNaN(n)||(n>=200&&n<300?p="#6A9955":n>=300&&n<400?p="#569CD6":n>=400&&n<500?p="#F44747":n>=500&&n<600&&(p="#C586C0")),v.set_markup(`<span foreground="${p}"><b>${se(E)}</b></span>`),typeof o.durationMs=="number"?P.label=`${Math.round(o.durationMs)} ms`:P.label="",typeof o.sizeBytes=="number"?O.label=`${(o.sizeBytes/1024).toFixed(1)} KB`:O.label=""}}}function ie(l={}){const _=new e.Box({orientation:e.Orientation.VERTICAL,spacing:6,hexpand:!0,vexpand:!0,margin_top:6,margin_bottom:6,margin_start:6,margin_end:6});let T=!1,L="raw";const r=new e.Label({label:"Raw"});r.css_classes=["dim-label"];const d=new e.Switch({active:!1}),h=new e.Box({orientation:e.Orientation.HORIZONTAL,spacing:6,halign:e.Align.START,valign:e.Align.CENTER,margin_start:8,margin_end:8,margin_bottom:6});h.append(r),h.append(d);const b=new e.Notebook({hexpand:!0,vexpand:!0});try{b.show_border=!1}catch{}_.append(b);const y=U.LanguageManager?.get_default?.(),B=y?y.get_language?.("json"):null,m=U.StyleSchemeManager?.get_default?.(),R=x=>{for(const f of x)try{const M=m?.get_scheme?.(f);if(M)return M}catch{}return null},i=new U.Buffer;try{i.highlight_syntax=!1,i.highlight_matching_brackets=!0}catch{}const w=q.StyleManager.get_default(),k=()=>{try{const x=!!w.dark,f=R(x?["Adwaita-dark","adwaita-dark","oblivion","cobalt","kate"]:["Adwaita","adwaita","classic","tango"]);i.style_scheme=f}catch{}};k();try{w.connect("notify::dark",k)}catch{}const a=new U.View({buffer:i,editable:!0,monospace:!0,wrap_mode:e.WrapMode.WORD_CHAR,hexpand:!0,vexpand:!0,left_margin:12,right_margin:12,top_margin:12,bottom_margin:12});try{a.show_line_numbers=!0,a.tab_width=2,a.indent_width=2,a.insert_spaces_instead_of_tabs=!0,a.auto_indent=!0,a.show_right_margin=!1,a.overwrite=!1}catch{}const u=new e.EventControllerKey;u.connect("key-pressed",(x,f,M,o)=>{if(f===Z.KEY_Tab&&!(o&Z.ModifierType.SHIFT_MASK)){const E=i;try{const t=E.get_selection_bounds?.();if(t&&t[0])return!1}catch{}const n=i.get_insert(),p=E.get_iter_at_mark(n);if(L==="json")try{const t=p.copy(),s=p.copy();for(;;){const I=s.copy();if(!I.backward_char?.())break;const H=String(I.get_char?.()??"");if(!/^[A-Za-z0-9_]$/.test(H))break;s.backward_char?.()}if(s.equal?.(t))return!1;const c=String(E.get_text(s,t,!0)??"");if(!c||!/^[A-Za-z_][A-Za-z0-9_]*$/.test(c))return!1;const g=s.copy();if(g.backward_char?.()&&String(g.get_char?.()??"")==='"')return!1;const S=t.copy();return String(S.get_char?.()??"")===":"?!1:(i.delete(s,t),i.insert(s,`"${c}": `,-1),!0)}catch{}return!1}return!1}),a.add_controller(u);const v=new e.ScrolledWindow({hexpand:!0,vexpand:!0});v.set_policy(e.PolicyType.NEVER,e.PolicyType.AUTOMATIC),v.set_child(a);const P=new e.Box({orientation:e.Orientation.VERTICAL,spacing:6,hexpand:!0,vexpand:!0});P.append(v),P.append(h),b.append_page(P,new e.Label({label:"Body"}));const O=x=>{const f=new e.ListBox;f.selection_mode=e.SelectionMode.NONE;const M=new e.ScrolledWindow({hexpand:!0,vexpand:!0});M.set_policy(e.PolicyType.NEVER,e.PolicyType.AUTOMATIC),M.set_child(f);const o=()=>{const s=[];let c=f.get_first_child();for(;c;){const g=c,S=g._keyEntry,A=g._valueEntry,I=S?.get_text?String(S.get_text()??""):String(S?.text??""),H=A?.get_text?String(A.get_text()??""):String(A?.text??"");I.trim()&&s.push({key:I.trim(),value:String(H??"")}),c=c.get_next_sibling?.()??null}return s},E=()=>{try{x.onChanged?.(o())}catch{}},n=()=>{const s=new e.ListBoxRow;s.selectable=!1,s.activatable=!1;const c=new e.Box({orientation:e.Orientation.HORIZONTAL,spacing:6,margin_top:8,margin_bottom:8,margin_start:8,margin_end:8}),g=new e.Entry({placeholder_text:x.keyPlaceholder});g.hexpand=!0;const S=new e.Entry({placeholder_text:x.valuePlaceholder});S.hexpand=!0;const A=new e.Button({css_classes:["flat"],icon_name:"window-close-symbolic"});A.valign=e.Align.CENTER,A.connect("clicked",()=>{try{f.remove(s)}catch{}E()}),s._keyEntry=g,s._valueEntry=S,g.connect("changed",E),S.connect("changed",E),c.append(g),c.append(S),c.append(A),s.set_child(c),f.append(s),E()},p=new e.Button({label:x.addLabel});p.css_classes=["flat"],p.halign=e.Align.START,p.connect("clicked",n);const t=new e.Box({orientation:e.Orientation.VERTICAL,spacing:6,hexpand:!0,vexpand:!0});return t.append(M),t.append(p),n(),b.append_page(t,new e.Label({label:x.tabLabel})),{getPairs:o}},V=O({tabLabel:"Query",addLabel:"Add Query Param",keyPlaceholder:"Key",valuePlaceholder:"Value",onChanged:l.onQueryParamsChanged}),j=O({tabLabel:"Header",addLabel:"Add Header",keyPlaceholder:"Header",valuePlaceholder:"Value"}),F=()=>{const x=i,f=i.get_start_iter(),M=i.get_end_iter();return typeof x.get_text=="function"?x.get_text(f,M,!0):""},N=x=>{T=!0,L=x,d.active=x==="raw",T=!1;try{L==="json"?(i.language=B,i.highlight_syntax=!0):(i.language=null,i.highlight_syntax=!1)}catch{}};return d.connect("notify::active",()=>{T||N(d.active?"raw":"json")}),N("json"),{widget:_,getSendOptions:()=>{const x=String(F()??""),f={};return x.trim()&&(f.body=x,L==="json"&&(f.contentType="application/json")),f.queryParams=V.getPairs(),f.headers=j.getPairs(),f}}}const Q=new J.Session,$=imports.byteArray,ce=l=>$.toString($.fromGBytes(l)),le=l=>new C.Bytes($.fromString(l));async function de(l,_={}){const T=_.method??"GET",L=C.get_monotonic_time(),r=J.Message.new(T,l)??new J.Message({method:T,uri:l});if(_.headers)for(const[w,k]of Object.entries(_.headers))r.request_headers.append(w,k);if(_.body!=null){const w=le(_.body);typeof r.set_request_body_from_bytes=="function"?r.set_request_body_from_bytes("application/json",w):typeof r.set_request_body=="function"&&r.set_request_body("application/json",w)}const d=await new Promise((w,k)=>{Q.send_and_read_async(r,C.PRIORITY_DEFAULT,null,(a,u)=>{try{w(Q.send_and_read_finish(u))}catch(v){k(v)}})}),h=C.get_monotonic_time(),b=Math.max(0,(h-L)/1e3),y=$.fromGBytes(d).length,B=r.get_status?r.get_status():r.status_code,m=(r.get_reason_phrase?r.get_reason_phrase():r.reason_phrase)??"",R={};try{const w=(typeof r.get_response_headers=="function"?r.get_response_headers():r.response_headers)??null;w&&typeof w.foreach=="function"&&w.foreach((k,a)=>{const u=String(k??"");if(!u)return;const v=String(a??"");R[u]||=[],R[u].push(v)})}catch{}const i={};for(const[w,k]of Object.entries(R))i[w]=k.join(", ");return{status:B,statusText:String(m),ok:B>=200&&B<300,durationMs:b,sizeBytes:y,headers:i,text:async()=>ce(d)}}const pe=imports.byteArray,Y=()=>{const l=C.build_filenamev([C.get_user_data_dir(),"zirest"]),_=G.File.new_for_path(l);try{_.make_directory_with_parents(null)}catch{}const T=C.build_filenamev([l,"request_history.json"]);return G.File.new_for_path(T)};function W(){const l=Y();try{if(!l.query_exists(null))return[];const _=l,[T,L]=_.load_contents(null),r=new globalThis.TextDecoder().decode(L),d=JSON.parse(r);return Array.isArray(d)?d.filter(h=>h&&typeof h=="object").map(h=>({method:String(h.method??"GET"),url:String(h.url??""),at:String(h.at??new Date().toISOString())})).filter(h=>h.url.length>0):[]}catch{return[]}}function X(l){const _=Y();try{const T=JSON.stringify(l,null,2),L=pe.fromString(T);_.replace_contents(L,null,!1,G.FileCreateFlags.REPLACE_DESTINATION,null)}catch{}}function ue(l){const _={method:String(l.method??"GET"),url:String(l.url??""),at:String(l.at??new Date().toISOString())};if(!_.url)return W();const T=W(),L=_.method.toUpperCase(),r=_.url,d=T.filter(b=>!(String(b.method).toUpperCase()===L&&String(b.url)===r)),h=[_,...d].slice(0,100);return X(h),h}const ee=new q.Application({applicationId:"dev.onderb.zirest"}),ge=q.StyleManager.get_default();ge.colorScheme=q.ColorScheme.DEFAULT;const _e=l=>{const _=new q.ApplicationWindow({application:l,title:"Zirest",default_width:960,default_height:640});_.connect("close-request",()=>(l.quit(),!1));const T=new q.HeaderBar({title_widget:new e.Label({label:"Zirest"})}),L=new e.MenuButton({icon_name:"document-open-recent-symbolic"});T.pack_start(L);const r=new e.Popover;L.set_popover(r);const d=new e.Box({orientation:e.Orientation.VERTICAL,spacing:8,margin_top:10,margin_bottom:10,margin_start:10,margin_end:10});d.halign=e.Align.FILL,d.hexpand=!0;try{d.set_size_request?.(520,-1)}catch{}const h=new e.SearchEntry({placeholder_text:"Search"});d.append(h);const b=new e.ListBox;b.selection_mode=e.SelectionMode.NONE;const y=new e.ScrolledWindow({hexpand:!0,vexpand:!1});y.halign=e.Align.FILL,y.set_policy(e.PolicyType.NEVER,e.PolicyType.AUTOMATIC),y.set_min_content_width?.(520);try{y.set_size_request?.(520,-1)}catch{}y.set_min_content_height?.(260),y.set_max_content_height?.(260);try{y.propagate_natural_height=!0}catch{}y.set_child(b),d.append(y),r.set_child(d);const B=new e.Box({orientation:e.Orientation.VERTICAL,spacing:6,margin_start:6,margin_end:6,margin_top:6,margin_bottom:6}),m=re(),R=(n,p)=>{const t=(p??[]).filter(z=>String(z.key??"").trim().length>0);if(!t.length)return String(n??"");const c=String(n??"").split("#"),g=c[0],S=c.length>1?`#${c.slice(1).join("#")}`:"",A=g.split("?"),I=A[0],H=A.length>1?A.slice(1).join("?"):"",D=t.map(z=>{const ne=encodeURIComponent(String(z.key??"").trim()),ae=encodeURIComponent(String(z.value??""));return`${ne}=${ae}`}).join("&"),te=[H,D].filter(Boolean).join("&");return`${I}?${te}${S}`};let i=null,w=!1;const k=ie({onQueryParamsChanged:n=>{const p=i;if(!p)return;const t=p.getRequest().url;if(w)return;const s=String(t??"").split("?")[0],c=R(s,n);if(String(c)!==String(t??"")){w=!0;try{p.setUrl(c)}finally{w=!1}}}}),a=new e.Box({orientation:e.Orientation.VERTICAL,spacing:12,hexpand:!0,vexpand:!0,halign:e.Align.CENTER,valign:e.Align.CENTER}),u=new e.Image({icon_name:"network-workgroup-symbolic",pixel_size:96}),v=new e.Label({label:"No response yet",wrap:!0,justify:e.Justification.CENTER});v.css_classes=["title-2"];const P=new e.Label({label:"Send a request to see its response here.",wrap:!0,justify:e.Justification.CENTER});P.css_classes=["dim-label"],a.append(u),a.append(v),a.append(P);const O=new q.ViewStack;O.hexpand=!0,O.vexpand=!0,O.add_titled(a,"empty",""),O.add_titled(m.widget,"response",""),O.visible_child_name="empty";const V=()=>{O.visible_child_name="response"},j=n=>{try{return new Date(n).toLocaleString()}catch{return n}},F=n=>C.markup_escape_text(n,-1);let N=W(),x="";const f=()=>{for(;;){const t=b.get_first_child();if(!t)break;b.remove(t)}const n=x.trim().toLowerCase(),p=n?N.filter(t=>{const s=String(t.method??"").toLowerCase(),c=String(t.url??"").toLowerCase();return s.includes(n)||c.includes(n)}):N;if(p.length===0){const t=new e.ListBoxRow;t.set_child(new e.Label({label:n?"No matches":"No history",xalign:0})),t.selectable=!1,t.activatable=!1,b.append(t);return}for(const t of p){const s=new e.ListBoxRow;s.selectable=!1,s.activatable=!1;const c=new e.Box({orientation:e.Orientation.HORIZONTAL,spacing:8}),g=new e.Button({css_classes:["flat"]});g.hexpand=!0,g.halign=e.Align.FILL;const S=new e.Box({orientation:e.Orientation.VERTICAL,spacing:2});S.hexpand=!0;const A=new e.Label({use_markup:!0,xalign:0});A.css_classes=["caption"],A.set_markup(`<b>${F(`${t.method.toUpperCase()} ${t.url}`)}</b>`),A.ellipsize=K.EllipsizeMode.END;const I=new e.Label({label:j(t.at),xalign:0});I.css_classes=["dim-label","caption"],S.append(A),S.append(I),g.set_child(S),g.connect("clicked",()=>{const D=i;D&&D.setRequest(t.method,t.url),r.popdown()});const H=new e.Button({css_classes:["flat"],icon_name:"window-close-symbolic"});H.valign=e.Align.CENTER,H.connect("clicked",()=>{N=N.filter(D=>!(String(D.method)===String(t.method)&&String(D.url)===String(t.url))),X(N),f()}),c.append(g),c.append(H),s.set_child(c),b.append(s)}};h.connect("search-changed",()=>{x=h.get_text?h.get_text():"",f()}),i=oe({onSend:(n,p)=>{const t=k.getSendOptions(),s=R(p,t.queryParams);N=ue({method:n,url:s}),f();const c={};t.contentType&&(c["Content-Type"]=t.contentType);for(const g of t.headers??[]){const S=String(g.key??"").trim();S&&(c[S]=String(g.value??""))}(async()=>{V(),m.setMeta({status:"â€¦",statusText:"Loading"}),m.setHeaders({}),m.setText(`Loading...
`+n+" "+s);try{const g=await de(s,{method:n,headers:Object.keys(c).length?c:void 0,body:t.body}),S=await g.text();m.setMeta({status:g.status,statusText:g.statusText,durationMs:g.durationMs,sizeBytes:g.sizeBytes}),m.setHeaders(g.headers);try{m.setJson(JSON.parse(S))}catch{m.setText(S)}}catch(g){m.setMeta({status:"ERR",statusText:"Error"}),m.setHeaders({}),m.setError(String(g))}})()}}),f();const M=new e.Paned({orientation:e.Orientation.HORIZONTAL,hexpand:!0,vexpand:!0});M.set_start_child(k.widget),M.set_end_child(O),C.idle_add(C.PRIORITY_DEFAULT_IDLE,()=>{try{M.set_position(280)}catch{}return C.SOURCE_REMOVE});const o=i;o&&B.append(o.widget),B.append(M);const E=new q.ToolbarView;E.add_top_bar(T),E.set_content(B),_.set_content(E),_.present()};ee.connect("activate",_e);ee.run([]);
